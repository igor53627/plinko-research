# =============================================================================
# PLINKO PIR POC - HELM VALUES
# =============================================================================
# This file contains default values for the Plinko PIR Helm chart.
# Override these values using values-vultr.yaml or --set flags.

# Global settings
global:
  # Storage class for PersistentVolumeClaims
  # Vultr uses "vultr-block-storage" or "vultr-block-storage-retain"
  storageClass: "vultr-block-storage"

  # Domain for ingress (set this for production)
  domain: ""

  # Enable TLS/HTTPS
  tls:
    enabled: false
    # Certificate manager issuer (e.g., letsencrypt-prod)
    issuer: ""

  # Node selector for pods that need shared RWO volume
  # Since Vultr Block Storage only supports RWO, all pods accessing
  # the shared volume must run on the same node
  nodeSelector:
    kubernetes.io/hostname: ""  # Set to specific node name (e.g., pir-7355993b0422)

# =============================================================================
# PERSISTENT STORAGE
# =============================================================================
# Shared data volume for binary files (database.bin, hint.bin, deltas/)
persistence:
  enabled: true
  storageClass: "vultr-block-storage"
  accessMode: ReadWriteOnce  # Vultr only supports RWO, use nodeSelector for pod affinity
  size: 20Gi
  # Annotations for Vultr Block Storage
  annotations:
    volume.beta.kubernetes.io/storage-class: "vultr-block-storage"

# =============================================================================
# SERVICE 1: ETH-MOCK (ANVIL)
# =============================================================================
# Simulated Ethereum blockchain with 8.4M pre-funded accounts
ethMock:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/foundry-rs/foundry
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 8545

  # Anvil configuration
  config:
    accounts: 8388608  # 2^23 accounts (Ethereum Warm Tier)
    balance: "10000000000000000000"  # 10 ETH in wei (reduced to fit in u64)
    blockTime: 12  # 12-second blocks (mainnet simulation)

  resources:
    requests:
      memory: "2Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "2000m"

  livenessProbe:
    enabled: false  # curl not available in Foundry image

  readinessProbe:
    enabled: false

# =============================================================================
# SERVICE 2: DB-GENERATOR
# =============================================================================
# One-time job to extract account balances from Anvil
dbGenerator:
  enabled: true

  image:
    repository: ghcr.io/igor53627/plinko-db-generator
    tag: latest
    pullPolicy: IfNotPresent

  # Job configuration (runs once)
  job:
    backoffLimit: 3
    ttlSecondsAfterFinished: 86400  # Keep job for 24h after completion
    restartPolicy: OnFailure

  config:
    dbSize: 8388608  # Must match ethMock.config.accounts
    entrySize: 8
    rpcUrl: "http://eth-mock:8545"
    concurrency: 10000

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

# =============================================================================
# SERVICE 3: PLINKO-HINT-GENERATOR
# =============================================================================
# One-time job to generate PIR hints from database.bin
plinkoHintGenerator:
  enabled: true

  image:
    repository: ghcr.io/igor53627/plinko-hint-generator
    tag: latest
    pullPolicy: IfNotPresent

  # Job configuration (runs once after db-generator)
  job:
    backoffLimit: 3
    ttlSecondsAfterFinished: 86400
    restartPolicy: OnFailure

  config:
    dbSize: 8388608
    chunkSize: 2896  # sqrt(8.4M)

  resources:
    requests:
      memory: "2Gi"
      cpu: "1000m"
    limits:
      memory: "4Gi"
      cpu: "2000m"

# =============================================================================
# SERVICE 4: PLINKO-UPDATE-SERVICE
# =============================================================================
# Always-on service for real-time incremental PIR updates
plinkoUpdateService:
  enabled: true
  replicaCount: 1

  image:
    repository: ghcr.io/igor53627/plinko-update-service
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 3001

  config:
    dbSize: 8388608
    chunkSize: 2896
    rpcUrl: "http://eth-mock:8545"
    cacheEnabled: true
    cacheSizeMB: 64
    blockPollInterval: 12  # seconds

  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"

  livenessProbe:
    enabled: true
    exec:
      command:
        - test
        - -d
        - /data/deltas
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    exec:
      command:
        - test
        - -d
        - /data/deltas
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 5

# =============================================================================
# SERVICE 5: PLINKO-PIR-SERVER
# =============================================================================
# Private query server (FullSet/PunctSet PIR)
plinkoPirServer:
  enabled: true
  replicaCount: 2  # Multiple instances for high availability

  image:
    repository: ghcr.io/igor53627/plinko-pir-server
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 3000

  config:
    dbSize: 8388608
    chunkSize: 2896

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 3000
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 5

  # Horizontal Pod Autoscaler
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# =============================================================================
# SERVICE 6: CDN-MOCK
# =============================================================================
# Serves hint.bin and delta files
cdnMock:
  enabled: true
  replicaCount: 2

  image:
    repository: nginx
    tag: alpine
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 8080

  config:
    # Enable gzip compression for hint.bin
    gzipEnabled: true
    # Enable CORS
    corsEnabled: true
    # Cache control headers
    cacheMaxAge: 3600  # 1 hour

  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "250m"

  livenessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70

# =============================================================================
# SERVICE 7: RABBY-WALLET
# =============================================================================
# User-facing wallet with Privacy Mode
rabbyWallet:
  enabled: true
  replicaCount: 2

  image:
    repository: ghcr.io/igor53627/plinko-rabby-wallet
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 80

  config:
    # These will be injected as build-time env vars
    pirServerUrl: ""  # Set via ingress or external URL
    cdnUrl: ""  # Set via ingress or external URL
    fallbackRpc: "https://eth.llamarpc.com"

  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "250m"

  livenessProbe:
    enabled: true
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    httpGet:
      path: /
      port: 80
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 5

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70

# =============================================================================
# INGRESS CONFIGURATION
# =============================================================================
# Exposes services via Vultr LoadBalancer
ingress:
  enabled: true
  className: "nginx"  # or "vultr" if available

  annotations:
    # Vultr LoadBalancer annotations
    service.beta.kubernetes.io/vultr-loadbalancer-protocol: "tcp"
    service.beta.kubernetes.io/vultr-loadbalancer-healthcheck-protocol: "http"
    service.beta.kubernetes.io/vultr-loadbalancer-healthcheck-path: "/health"
    # Nginx ingress annotations
    # Use $2 to capture the path after /api or /cdn
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # CORS for CDN
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    # Increase body size for large queries
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

  hosts:
    # Wallet (main UI)
    - host: ""  # e.g., plinko-wallet.example.com
      paths:
        - path: /
          pathType: Prefix
          service: rabby-wallet
          port: 80

    # PIR Server
    - host: ""  # e.g., plinko-api.example.com
      paths:
        - path: /
          pathType: Prefix
          service: plinko-pir-server
          port: 3000

    # CDN
    - host: ""  # e.g., plinko-cdn.example.com
      paths:
        - path: /
          pathType: Prefix
          service: cdn-mock
          port: 8080

  tls: []
  # - secretName: plinko-tls
  #   hosts:
  #     - plinko-wallet.example.com
  #     - plinko-api.example.com
  #     - plinko-cdn.example.com

# =============================================================================
# NETWORK POLICIES (OPTIONAL)
# =============================================================================
# Restrict network access between services
networkPolicy:
  enabled: false
  policyTypes:
    - Ingress
    - Egress

# =============================================================================
# SERVICE MESH (OPTIONAL)
# =============================================================================
# Enable Istio/Linkerd for advanced networking
serviceMesh:
  enabled: false
  type: "none"  # "istio" or "linkerd"

# =============================================================================
# MONITORING AND OBSERVABILITY
# =============================================================================
monitoring:
  # Prometheus metrics
  prometheus:
    enabled: false
    serviceMonitor:
      enabled: false
      interval: 30s
      scrapeTimeout: 10s

  # Grafana dashboards
  grafana:
    enabled: false
    dashboards:
      enabled: false

  # Loki logging
  loki:
    enabled: false

# =============================================================================
# SECURITY
# =============================================================================
security:
  # Pod Security Policy
  podSecurityPolicy:
    enabled: false

  # Security Context for pods
  podSecurityContext:
    runAsNonRoot: false  # Some services need root for initialization
    fsGroup: 1000

  # Container Security Context
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false  # Services need write access to /data
    capabilities:
      drop:
        - ALL

# =============================================================================
# BACKUP AND DISASTER RECOVERY
# =============================================================================
backup:
  enabled: false
  schedule: "0 2 * * *"  # Daily at 2 AM
  retention: 7  # Keep 7 days of backups
  volumeSnapshots:
    enabled: false

# =============================================================================
# DEVELOPMENT AND DEBUGGING
# =============================================================================
debug:
  enabled: false
  logLevel: "info"  # trace, debug, info, warn, error
