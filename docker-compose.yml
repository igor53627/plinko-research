# =============================================================================
# PLINKO PIR + PLINKO POC - SERVICE ORCHESTRATION
# =============================================================================
#
# NETWORK ARCHITECTURE:
#
# External Access (from host/browser):
#   - Plinko PIR Server:    http://localhost:3000
#   - Plinko Update Service: http://localhost:3001 (health check only)
#   - CDN Mock:             http://localhost:8080
#   - Ambire Wallet:        http://localhost:5173
#   - Anvil:                Not exposed (Docker internal only)
#
# Docker Internal Communication (service-to-service):
#   - Services use Docker network service names:
#     * eth-mock:8545          (Ethereum RPC)
#     * plinko-pir-server:3000 (PIR queries)
#     * cdn-mock:8080          (CDN)
#     * plinko-pir-updates:3001 (Update service)
#
# Custom Domain Setup (Optional):
#   See .env.example for instructions on configuring custom local domains
#   (e.g., plinko-server.local, plinko-cdn.local)
#
# =============================================================================

services:
  # Service 1: Ethereum Mock (Anvil)
  # Address: eth-mock:8545 (Docker internal only)
  # Purpose: Simulated Ethereum blockchain with 8.4M pre-funded accounts
  # Service 1: Ethereum Mock (Anvil) - DISABLED for Production
  # eth-mock:
  #   build: ./services/eth-mock
  #   container_name: plinko-pir-eth-mock
  #   volumes:
  #     - shared-data:/data
  #   networks:
  #     - plinko-network

  # Service 2: Plinko Update Service (always running)
  # External: http://localhost:3001 (health check only)
  # Internal: plinko-pir-updates:3001
  # Purpose: Real-time incremental PIR updates
  plinko-update-service:
    build: ./services/plinko-update-service
    container_name: plinko-pir-updates
    ports:
      - "3001:3001"
    environment:
      - PLINKO_UPDATE_RPC_URL=${PLINKO_UPDATE_RPC_URL:-https://ethereum.publicnode.com}
      - PLINKO_UPDATE_SIMULATED=false
    volumes:
      - shared-data:/data
      - public-artifacts:/public
    # depends_on:
    #   eth-mock:
    #     condition: service_started
    healthcheck:
      test: ["CMD", "test", "-d", "/data/deltas"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - plinko-network

  state-syncer:
    build: ./services/state-syncer
    container_name: plinko-state-syncer
    environment:
      - PLINKO_STATE_RPC_URL=${PLINKO_STATE_RPC_URL:-https://ethereum.publicnode.com}
      - PLINKO_STATE_RPC_TOKEN=${PLINKO_STATE_RPC_TOKEN:-}
      - PLINKO_STATE_START_BLOCK=${PLINKO_STATE_START_BLOCK:-0}
      - PLINKO_STATE_SIMULATED=false
      - PLINKO_STATE_HTTP_PORT=${PLINKO_STATE_HTTP_PORT:-3002}
      - PLINKO_STATE_IPFS_API=${PLINKO_STATE_IPFS_API:-http://ipfs:5001}
      - PLINKO_STATE_IPFS_GATEWAY=${PLINKO_STATE_IPFS_GATEWAY:-/cdn/ipfs}
    volumes:
      - shared-data:/data
      - public-artifacts:/public
    ports:
      - "3002:3002"
    depends_on:
      ipfs:
        condition: service_started
    restart: unless-stopped
    networks:
      - plinko-network

  # Service 4: Plinko PIR Server
  # External: http://localhost:3000
  # Internal: plinko-pir-server:3000
  # Purpose: Private query server (FullSet/PunctSet PIR)
  plinko-pir-server:
    build: ./services/plinko-pir-server
    container_name: plinko-pir-server
    ports:
      - "3000:3000"
    volumes:
      - shared-data:/data:ro  # Read-only access
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - plinko-network

  # Service 5: CDN Mock
  # External: http://localhost:8080
  # Internal: cdn-mock:8080
  # Purpose: Serve versioned public snapshots + delta feeds
  cdn-mock:
    build: ./services/cdn-mock
    container_name: plinko-pir-cdn
    ports:
      - "8080:8080"
    volumes:
      - public-artifacts:/public:ro
    depends_on:
      plinko-update-service:
        condition: service_healthy
    networks:
      - plinko-network

  # Service 6: Rabby Wallet
  # External: http://localhost:5173
  # Internal: rabby-wallet:80
  # Purpose: User-facing wallet with Privacy Mode
  rabby-wallet:
    build: ./services/rabby-wallet
    container_name: plinko-wallet
    ports:
      - "80:80"  # Expose directly on port 80, replacing the old proxy
    environment:
      - VITE_PIR_SERVER_URL=${VITE_PIR_SERVER_URL:-http://localhost:3000}
      - VITE_CDN_URL=${VITE_CDN_URL:-http://localhost:8080}
      - VITE_FALLBACK_RPC=${VITE_FALLBACK_RPC:-https://eth.llamarpc.com}
    depends_on:
      plinko-pir-server:
        condition: service_healthy
      cdn-mock:
        condition: service_started
    networks:
      - plinko-network

  ipfs:
    image: ipfs/kubo:latest
    container_name: plinko-ipfs
    environment:
      - IPFS_PROFILE=server
    volumes:
      - ipfs-data:/data/ipfs
    ports:
      - "5001:5001"  # API (HTTP) for local tooling; gateway left internal
    networks:
      - plinko-network

# Define explicit network for better service discovery
networks:
  plinko-network:
    driver: bridge
    name: plinko-pir-network

volumes:
  shared-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
  public-artifacts:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./public-data
  ipfs-data:
